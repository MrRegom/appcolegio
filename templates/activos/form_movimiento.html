{% extends 'partials/base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="page-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                    <h4 class="mb-sm-0">{{ titulo }}</h4>
                    <div class="page-title-right">
                        <ol class="breadcrumb m-0">
                            <li class="breadcrumb-item"><a href="{% url 'dashboard_analytics' %}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'activos:lista_movimientos' %}">Movimientos</a></li>
                            <li class="breadcrumb-item active">{{ action }}</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <form method="post" id="form-movimiento">
            {% csrf_token %}

            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Información del Movimiento</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.activo.label }} <span class="text-danger">*</span></label>
                                    {{ form.activo }}
                                    {% if form.activo.errors %}<div class="invalid-feedback d-block">{{ form.activo.errors }}</div>{% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">{{ form.estado_nuevo.label }} <span class="text-danger">*</span></label>
                                    {{ form.estado_nuevo }}
                                    {% if form.estado_nuevo.errors %}<div class="invalid-feedback d-block">{{ form.estado_nuevo.errors }}</div>{% endif %}
                                    <small class="text-muted">Estado al que se cambiará el activo</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card de información del activo seleccionado -->
                    <div class="card" id="card-info-activo" style="display: none;">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">
                                <i class="ri-information-line me-2"></i>Información del Activo Seleccionado
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <strong>Código:</strong>
                                    <p class="mb-0" id="info-codigo">-</p>
                                </div>
                                <div class="col-md-4">
                                    <strong>Nombre:</strong>
                                    <p class="mb-0" id="info-nombre">-</p>
                                </div>
                                <div class="col-md-4">
                                    <strong>Categoría:</strong>
                                    <p class="mb-0" id="info-categoria">-</p>
                                </div>
                                <div class="col-md-4">
                                    <strong>Estado Actual:</strong>
                                    <p class="mb-0" id="info-estado">-</p>
                                </div>
                                <div class="col-md-4">
                                    <strong>Marca:</strong>
                                    <p class="mb-0" id="info-marca">-</p>
                                </div>
                                <div class="col-md-4">
                                    <strong>Número de Serie:</strong>
                                    <p class="mb-0" id="info-serie">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Ubicación y Responsable</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label">{{ form.ubicacion_destino.label }}</label>
                                    {{ form.ubicacion_destino }}
                                    {% if form.ubicacion_destino.errors %}<div class="invalid-feedback d-block">{{ form.ubicacion_destino.errors }}</div>{% endif %}
                                    <small class="text-muted">Ubicación física donde se encuentra el activo</small>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">{{ form.responsable.label }}</label>
                                    {{ form.responsable }}
                                    {% if form.responsable.errors %}<div class="invalid-feedback d-block">{{ form.responsable.errors }}</div>{% endif %}
                                    <small class="text-muted">Usuario responsable del activo</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Otros Detalles</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label">{{ form.taller.label }}</label>
                                    {{ form.taller }}
                                    {% if form.taller.errors %}<div class="invalid-feedback d-block">{{ form.taller.errors }}</div>{% endif %}
                                    <small class="text-muted">Taller asociado al movimiento (opcional)</small>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">{{ form.proveniencia.label }}</label>
                                    {{ form.proveniencia }}
                                    {% if form.proveniencia.errors %}<div class="invalid-feedback d-block">{{ form.proveniencia.errors }}</div>{% endif %}
                                    <small class="text-muted">Origen o procedencia del activo (opcional)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Observaciones</h5>
                        </div>
                        <div class="card-body">
                            {{ form.observaciones }}
                            {% if form.observaciones.errors %}<div class="invalid-feedback d-block">{{ form.observaciones.errors }}</div>{% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="text-end">
                        <a href="{% url 'activos:lista_movimientos' %}" class="btn btn-light">
                            <i class="ri-close-line"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="ri-save-line"></i> {{ action }} Movimiento
                        </button>
                    </div>
                </div>
            </div>
        </form>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const activoSelect = document.getElementById('id_activo');
    const cardInfoActivo = document.getElementById('card-info-activo');

    // Objeto para almacenar información de activos
    const activosInfo = {};

    // Cargar información de activos al cargar la página
    {% for activo in form.fields.activo.queryset %}
    activosInfo[{{ activo.pk }}] = {
        codigo: '{{ activo.codigo }}',
        nombre: '{{ activo.nombre }}',
        categoria: '{{ activo.categoria.nombre }}',
        estado: '{{ activo.estado.nombre }}',
        marca: '{{ activo.marca.nombre|default:"-" }}',
        numero_serie: '{{ activo.numero_serie|default:"-" }}'
    };
    {% endfor %}

    // Actualizar información del activo según el seleccionado
    function updateActivoInfo() {
        const activoId = activoSelect.value;

        if (!activoId || !activosInfo[activoId]) {
            // Ocultar card de información
            cardInfoActivo.style.display = 'none';
            return;
        }

        const activo = activosInfo[activoId];

        // Actualizar la información en el card
        document.getElementById('info-codigo').textContent = activo.codigo;
        document.getElementById('info-nombre').textContent = activo.nombre;
        document.getElementById('info-categoria').textContent = activo.categoria;
        document.getElementById('info-estado').textContent = activo.estado;
        document.getElementById('info-marca').textContent = activo.marca;
        document.getElementById('info-serie').textContent = activo.numero_serie;

        // Mostrar card de información
        cardInfoActivo.style.display = 'block';
    }

    // Configurar evento
    activoSelect.addEventListener('change', updateActivoInfo);

    // Ejecutar al cargar si ya hay un activo seleccionado
    if (activoSelect.value) {
        updateActivoInfo();
    }
});
</script>
{% endblock %}
